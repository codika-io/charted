---
import BaseLayout from '../layouts/BaseLayout.astro';
import DottedSeparator from '../components/DottedSeparator.astro';
import TopicMap from '../components/islands/TopicMap';
import { MATHEMATICS_TOPICS, MATHEMATICS_EDGES, COMPUTER_SCIENCE_TOPICS, COMPUTER_SCIENCE_EDGES } from '../components/islands/TopicMap';
---

<BaseLayout title="Home">
  <!-- Hero -->
  <section class="relative overflow-hidden">
    <div class="dot-grid absolute inset-0 opacity-40"></div>
    <div class="max-w-6xl mx-auto px-6 pt-20 pb-16 relative">
      <div class="flex flex-col lg:flex-row items-center gap-12 lg:gap-16">
        <!-- Text -->
        <div class="flex-1 text-center lg:text-left">
          <h1 class="text-5xl md:text-7xl mb-6 tracking-tight">
            Chart<span id="hero-ed" class="text-surface-900" style="transition: color 0.3s ease">ed</span>
          </h1>
          <p class="text-xl md:text-2xl text-surface-600 max-w-xl leading-relaxed">
            An interactive, open-source atlas of the sciences.
            Explore how fields connect, evolve, and build on each other.
          </p>
          <div class="mt-8 flex gap-4 justify-center lg:justify-start">
            <div id="hero-dropdown" class="relative group">
              <span
                class="inline-block font-mono text-sm uppercase tracking-wider bg-surface-900 text-white px-6 py-3 group-hover:bg-surface-700 transition-colors cursor-default"
                data-hover-sound
              >
                Explore the maps
              </span>
              <div class="absolute top-full left-0 min-w-full opacity-0 invisible translate-y-1 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 transition-all duration-200 z-10">
                <a
                  href="#mathematics"
                  class="block font-mono text-sm uppercase tracking-wider text-white px-6 py-3 whitespace-nowrap hover:brightness-110 transition-all"
                  style="background-color: #dc2626;"
                  data-hover-sound
                  data-hero-domain="mathematics"
                >
                  Mathematics
                </a>
                <a
                  href="#computer-science"
                  class="block font-mono text-sm uppercase tracking-wider text-white px-6 py-3 whitespace-nowrap hover:brightness-110 transition-all"
                  style="background-color: #2563eb;"
                  data-hover-sound
                  data-hero-domain="computer-science"
                >
                  Computer Science
                </a>
              </div>
            </div>
            <a
              href="https://github.com/codika-io/charted"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-block font-mono text-sm uppercase tracking-wider border border-surface-300 text-surface-600 px-6 py-3 hover:border-surface-500 hover:text-surface-900 transition-colors"
            >
              Contribute
            </a>
          </div>
        </div>

        <!-- Isometric illustration -->
        <div class="flex-1 flex justify-center">
          <svg id="hero-chart" viewBox="0 0 400 360" width="400" height="360" class="w-full max-w-md">
            <!-- Axes -->
            <g stroke="#d4d4d4" stroke-width="1" stroke-dasharray="4 3">
              <line x1="60" y1="280" x2="340" y2="280" />
              <line x1="60" y1="280" x2="60" y2="40" />
              <line x1="60" y1="220" x2="340" y2="220" />
              <line x1="60" y1="160" x2="340" y2="160" />
              <line x1="60" y1="100" x2="340" y2="100" />
              <line x1="130" y1="280" x2="130" y2="40" />
              <line x1="200" y1="280" x2="200" y2="40" />
              <line x1="270" y1="280" x2="270" y2="40" />
            </g>

            <!-- Block 0: cx=130 baseY=240 hw=30 neutral wh=50 -->
            <g id="hero-block-0">
              <polygon points="130,240 160,225 160,175 130,190" fill="#a3a3a3" opacity="0.5" />
              <polygon points="130,240 100,225 100,175 130,190" fill="#a3a3a3" opacity="0.7" />
              <polygon points="100,175 130,160 160,175 130,190" fill="#a3a3a3" opacity="0.9" />
              <polygon points="100,175 130,160 160,175 130,190" fill="none" stroke="#a3a3a3" stroke-width="1.5" opacity="0.9" />
              <polygon points="130,240 160,225 160,175 130,190" fill="none" stroke="#a3a3a3" stroke-width="1" opacity="0.6" />
              <polygon points="130,240 100,225 100,175 130,190" fill="none" stroke="#a3a3a3" stroke-width="1" opacity="0.6" />
            </g>

            <!-- Block 1: cx=200 baseY=260 hw=30 neutral wh=40 -->
            <g id="hero-block-1">
              <polygon points="200,260 230,245 230,205 200,220" fill="#a3a3a3" opacity="0.5" />
              <polygon points="200,260 170,245 170,205 200,220" fill="#a3a3a3" opacity="0.7" />
              <polygon points="170,205 200,190 230,205 200,220" fill="#a3a3a3" opacity="0.9" />
              <polygon points="170,205 200,190 230,205 200,220" fill="none" stroke="#a3a3a3" stroke-width="1.5" opacity="0.9" />
              <polygon points="200,260 230,245 230,205 200,220" fill="none" stroke="#a3a3a3" stroke-width="1" opacity="0.6" />
              <polygon points="200,260 170,245 170,205 200,220" fill="none" stroke="#a3a3a3" stroke-width="1" opacity="0.6" />
            </g>

            <!-- Block 2: cx=270 baseY=270 hw=30 neutral wh=30 -->
            <g id="hero-block-2">
              <polygon points="270,270 300,255 300,225 270,240" fill="#a3a3a3" opacity="0.5" />
              <polygon points="270,270 240,255 240,225 270,240" fill="#a3a3a3" opacity="0.7" />
              <polygon points="240,225 270,210 300,225 270,240" fill="#a3a3a3" opacity="0.9" />
              <polygon points="240,225 270,210 300,225 270,240" fill="none" stroke="#a3a3a3" stroke-width="1.5" opacity="0.9" />
              <polygon points="270,270 300,255 300,225 270,240" fill="none" stroke="#a3a3a3" stroke-width="1" opacity="0.6" />
              <polygon points="270,270 240,255 240,225 270,240" fill="none" stroke="#a3a3a3" stroke-width="1" opacity="0.6" />
            </g>

            <!-- Block 3: cx=200 baseY=200 hw=20 neutral wh=50 -->
            <g id="hero-block-3">
              <polygon points="200,200 220,190 220,140 200,150" fill="#a3a3a3" opacity="0.5" />
              <polygon points="200,200 180,190 180,140 200,150" fill="#a3a3a3" opacity="0.7" />
              <polygon points="180,140 200,130 220,140 200,150" fill="#a3a3a3" opacity="0.9" />
              <polygon points="180,140 200,130 220,140 200,150" fill="none" stroke="#a3a3a3" stroke-width="1.5" opacity="0.9" />
              <polygon points="200,200 220,190 220,140 200,150" fill="none" stroke="#a3a3a3" stroke-width="1" opacity="0.6" />
              <polygon points="200,200 180,190 180,140 200,150" fill="none" stroke="#a3a3a3" stroke-width="1" opacity="0.6" />
            </g>

            <!-- Floating point markers -->
            <circle id="hero-dot-0" cx="130" cy="150" r="4" fill="#a3a3a3" />
            <circle id="hero-dot-1" cx="200" cy="120" r="4" fill="#a3a3a3" />
            <circle id="hero-dot-2" cx="270" cy="205" r="3" fill="#a3a3a3" opacity="0.6" />

            <!-- Connecting dotted lines -->
            <line id="hero-line-0" x1="130" y1="150" x2="200" y2="120" stroke="#a3a3a3" stroke-width="1" stroke-dasharray="3 3" opacity="0.5" />
            <line id="hero-line-1" x1="200" y1="120" x2="270" y2="205" stroke="#a3a3a3" stroke-width="1" stroke-dasharray="3 3" opacity="0.5" />

            <!-- Axis labels -->
            <text x="340" y="295" font-size="10" fill="#a3a3a3" text-anchor="end" style="font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 0.1em;">breadth</text>
            <text x="48" y="45" font-size="10" fill="#a3a3a3" style="font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 0.1em;">depth</text>

            <!-- Formula decoration -->
            <text x="280" y="165" font-size="14" fill="#d4d4d4" font-style="italic" style="font-family: var(--font-serif);">f(x) = ?</text>
          </svg>
        </div>
      </div>
    </div>
  </section>

  <div class="max-w-6xl mx-auto px-6">
    <DottedSeparator />
  </div>

  <!-- About blurb -->
  <section class="max-w-6xl mx-auto px-6 py-12">
    <div class="max-w-2xl">
      <h2 class="text-2xl mb-6">What is this?</h2>
      <p class="text-surface-600 leading-relaxed mb-4">
        Charted is an open-source project to build an interactive map of human knowledge, starting with mathematics. Each topic is a node you can explore — read about it, see how it connects to other fields, and trace the prerequisites that lead there.
      </p>
      <p class="text-surface-600 leading-relaxed">
        Anyone can contribute. Add a topic, improve an explanation, draw a connection. The goal is not to be an encyclopedia — it's to show the shape of each science as a living, interconnected whole.
      </p>
    </div>
  </section>

  <div class="max-w-6xl mx-auto px-6">
    <DottedSeparator />
  </div>

  <!-- Mathematics Map -->
  <section id="mathematics" data-domain="mathematics" class="max-w-6xl mx-auto px-6 py-12">
    <h2 class="text-2xl mb-2 text-accent-600">Mathematics</h2>
    <p class="text-surface-500 font-mono text-sm uppercase tracking-wider mb-8">Click a topic to explore</p>
    <TopicMap client:load topics={MATHEMATICS_TOPICS} edges={MATHEMATICS_EDGES} />
  </section>

  <div class="max-w-6xl mx-auto px-6">
    <DottedSeparator />
  </div>

  <!-- Computer Science Map -->
  <section id="computer-science" data-domain="computer-science" class="max-w-6xl mx-auto px-6 py-12">
    <h2 class="text-2xl mb-2 text-accent-600">Computer Science</h2>
    <p class="text-surface-500 font-mono text-sm uppercase tracking-wider mb-8">Click a topic to explore</p>
    <TopicMap client:load topics={COMPUTER_SCIENCE_TOPICS} edges={COMPUTER_SCIENCE_EDGES} />
  </section>

  <div class="max-w-6xl mx-auto px-6">
    <DottedSeparator />
  </div>

  <!-- CTA -->
  <section class="max-w-6xl mx-auto px-6 py-16 text-center">
    <h2 class="text-2xl mb-4">Help map the sciences</h2>
    <p class="text-surface-600 max-w-lg mx-auto mb-8">
      Charted is built by contributors. Pick a topic you know, write about it, and submit a pull request.
    </p>
    <a
      href="https://github.com/codika-io/charted"
      target="_blank"
      rel="noopener noreferrer"
      class="inline-block font-mono text-sm uppercase tracking-wider bg-surface-900 text-white px-8 py-3 hover:bg-surface-800 transition-colors"
    >
      Start Contributing
    </a>
  </section>

  <!-- Hero chart animation script -->
  <script>
    const GEOM = [
      { cx: 130, baseY: 240, hw: 30 },
      { cx: 200, baseY: 260, hw: 30 },
      { cx: 270, baseY: 270, hw: 30 },
      { cx: 200, baseY: 200, hw: 20 },
    ];

    const DOTS = [
      { cx: 130, block: 0, offset: 10 },
      { cx: 200, block: 3, offset: 10 },
      { cx: 270, block: 2, offset: 5 },
    ];

    const GRAY = [163, 163, 163]; // #a3a3a3
    const RED = [239, 68, 68];    // #ef4444
    const RED_L = [252, 165, 165]; // #fca5a5
    const BLUE = [59, 130, 246];  // #3b82f6
    const BLUE_L = [147, 197, 253]; // #93c5fd
    const DARK = [23, 23, 23];    // #171717 (surface-900)

    const STATES: Record<string, { heights: number[]; colors: number[][]; accent: number[]; edColor: number[] }> = {
      neutral: {
        heights: [50, 40, 30, 50],
        colors: [GRAY, GRAY, GRAY, GRAY],
        accent: GRAY,
        edColor: DARK,
      },
      mathematics: {
        heights: [100, 70, 40, 100],
        colors: [RED, RED, RED_L, RED],
        accent: RED,
        edColor: RED,
      },
      'computer-science': {
        heights: [40, 95, 65, 110],
        colors: [BLUE, BLUE, BLUE_L, BLUE],
        accent: BLUE,
        edColor: BLUE,
      },
    };

    // Current animated values
    const cur = {
      wh: [50, 40, 30, 50],
      colors: [GRAY.slice(), GRAY.slice(), GRAY.slice(), GRAY.slice()],
      accent: GRAY.slice(),
      edColor: DARK.slice(),
    };

    let target = 'neutral';
    let raf = 0;

    // DOM refs
    const blocks = [0, 1, 2, 3].map(i =>
      document.getElementById(`hero-block-${i}`)!.querySelectorAll('polygon')
    );
    const dots = [0, 1, 2].map(i => document.getElementById(`hero-dot-${i}`)!);
    const lines = [0, 1].map(i => document.getElementById(`hero-line-${i}`)!);
    const edSpan = document.getElementById('hero-ed')!;

    function toHex(rgb: number[]) {
      return '#' + rgb.map(c => Math.round(c).toString(16).padStart(2, '0')).join('');
    }

    function pts(cx: number, baseY: number, hw: number, wh: number) {
      const bR = baseY - hw / 2;
      const tR = bR - wh;
      return {
        right: `${cx},${baseY} ${cx + hw},${bR} ${cx + hw},${tR} ${cx},${baseY - wh}`,
        left: `${cx},${baseY} ${cx - hw},${bR} ${cx - hw},${tR} ${cx},${baseY - wh}`,
        top: `${cx - hw},${tR} ${cx},${baseY - hw - wh} ${cx + hw},${tR} ${cx},${baseY - wh}`,
      };
    }

    function lerpArr(a: number[], b: number[], t: number) {
      for (let i = 0; i < a.length; i++) a[i] += (b[i] - a[i]) * t;
    }

    function settled(a: number[], b: number[], eps: number) {
      return a.every((v, i) => Math.abs(v - b[i]) < eps);
    }

    function snap(a: number[], b: number[], eps: number) {
      if (settled(a, b, eps)) { for (let i = 0; i < a.length; i++) a[i] = b[i]; return true; }
      return false;
    }

    function animate() {
      const s = STATES[target];
      let done = true;
      const E = 0.25;

      for (let i = 0; i < 4; i++) {
        // Height
        cur.wh[i] += (s.heights[i] - cur.wh[i]) * E;
        if (Math.abs(cur.wh[i] - s.heights[i]) < 0.3) cur.wh[i] = s.heights[i]; else done = false;

        // Color
        lerpArr(cur.colors[i], s.colors[i], E);
        if (!snap(cur.colors[i], s.colors[i], 1)) done = false;

        // Update polygons
        const { cx, baseY, hw } = GEOM[i];
        const p = pts(cx, baseY, hw, cur.wh[i]);
        const col = toHex(cur.colors[i]);
        const polys = blocks[i];
        polys[0].setAttribute('points', p.right); polys[0].setAttribute('fill', col);
        polys[1].setAttribute('points', p.left); polys[1].setAttribute('fill', col);
        polys[2].setAttribute('points', p.top); polys[2].setAttribute('fill', col);
        polys[3].setAttribute('points', p.top); polys[3].setAttribute('stroke', col);
        polys[4].setAttribute('points', p.right); polys[4].setAttribute('stroke', col);
        polys[5].setAttribute('points', p.left); polys[5].setAttribute('stroke', col);
      }

      // Accent (dots + lines)
      lerpArr(cur.accent, s.accent, E);
      if (!snap(cur.accent, s.accent, 1)) done = false;
      const acHex = toHex(cur.accent);

      for (let i = 0; i < DOTS.length; i++) {
        const d = DOTS[i];
        const { baseY, hw } = GEOM[d.block];
        dots[i].setAttribute('cy', String(baseY - hw - cur.wh[d.block] - d.offset));
        dots[i].setAttribute('fill', acHex);
      }

      const dotCys = DOTS.map(d => {
        const { baseY, hw } = GEOM[d.block];
        return baseY - hw - cur.wh[d.block] - d.offset;
      });
      lines[0].setAttribute('y1', String(dotCys[0])); lines[0].setAttribute('y2', String(dotCys[1]));
      lines[0].setAttribute('stroke', acHex);
      lines[1].setAttribute('y1', String(dotCys[1])); lines[1].setAttribute('y2', String(dotCys[2]));
      lines[1].setAttribute('stroke', acHex);

      // "ed" color
      lerpArr(cur.edColor, s.edColor, 0.45);
      if (!snap(cur.edColor, s.edColor, 1)) done = false;
      edSpan.style.color = toHex(cur.edColor);

      if (!done) raf = requestAnimationFrame(animate); else raf = 0;
    }

    function transitionTo(state: string) {
      target = state;
      if (!raf) raf = requestAnimationFrame(animate);
    }

    document.querySelectorAll<HTMLElement>('[data-hero-domain]').forEach(el => {
      el.addEventListener('mouseenter', () => transitionTo(el.dataset.heroDomain!));
    });

    document.getElementById('hero-dropdown')!.addEventListener('mouseleave', () => {
      transitionTo('neutral');
    });
  </script>
</BaseLayout>
